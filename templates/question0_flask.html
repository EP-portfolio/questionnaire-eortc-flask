{% extends "base_flask.html" %}

{% block title %}Question 0 - Tests Audio et Micro{% endblock %}

{% block content %}
<div class="permission-page">
    <!-- Titre principal -->
    <div class="welcome-box">
        <h1 class="welcome-title">
            <i class="fas fa-hospital"></i>
            Questionnaire EORTC QLQ-C30
        </h1>
        <p class="welcome-subtitle">Question 0 - Configuration audio et microphone</p>
    </div>

    <!-- Informations mode continu -->
    <div class="info-box">
        <h3 class="info-title">
            <i class="fas fa-check-circle"></i>
            Mode continu activé
        </h3>
        <p class="info-text">
            <strong>→ 1 SEUL clic au démarrage</strong><br>
            <strong>→ Parlez naturellement pour chaque question</strong><br>
            <strong>→ Passage automatique à la question suivante</strong><br>
            <strong>→ Boutons disponibles si besoin</strong>
        </p>
    </div>

    <!-- Tests recommandés -->
    <div class="tests-section">
        <div class="info-box">
            <h3 class="info-title">
                <i class="fas fa-clipboard-check"></i>
                Tests recommandés
            </h3>
            <p class="info-text">
                <strong>1. Testez l'audio</strong> pour vérifier que vous entendez les questions<br>
                <strong>2. Cochez la case</strong> pour confirmer que vous avez entendu le test<br>
                <strong>3. Testez le microphone</strong> pour valider le fonctionnement<br>
                <strong>4. Autorisez l'accès</strong> au micro dans le navigateur
            </p>
        </div>

        <div class="test-buttons">
            <div class="test-group">
                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-volume-up"></i>
                        Audio
                    </h4>
                    <p class="test-desc">Les questions seront lues à voix haute.</p>
                    <button class="test-btn" id="test-audio-btn" onclick="testAudio()">
                        <i class="fas fa-play"></i>
                        Tester l'audio
                    </button>
                </div>

                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-microphone"></i>
                        Microphone
                    </h4>
                    <p class="test-desc">Validation du fonctionnement.</p>
                    <button class="test-btn" id="test-micro-btn" onclick="testMicrophone()">
                        <i class="fas fa-microphone"></i>
                        Tester le micro
                    </button>
                </div>
            </div>
        </div>

        <!-- Case à cocher pour validation audio -->
        <div class="audio-confirmation" id="audio-confirmation" style="display: none;">
            <div class="checkbox-validation">
                <label class="checkbox-label-large">
                    <input type="checkbox" id="audio-confirmed" name="audio_confirmed">
                    <span class="checkmark-large"></span>
                    <span class="checkbox-text">Cochez si vous avez entendu le test audio</span>
                </label>
            </div>
        </div>

        <!-- Test microphone -->
        <div class="microphone-test" id="microphone-test" style="display: none;">
            <div class="test-info">
                <h4>Test : Cliquez, parlez, puis attendez 2 secondes</h4>
            </div>
            <div class="recorder-container">
                <button class="recorder-btn" id="recorder-btn" onclick="startRecording()">
                    <i class="fas fa-microphone"></i>
                    <span>🎤 Tester</span>
                </button>
            </div>
            <div class="recording-feedback" id="recording-feedback" style="display: none;">
                <p class="feedback-text"></p>
            </div>
            <button class="cancel-btn" onclick="cancelMicrophoneTest()">
                <i class="fas fa-times"></i>
                Annuler
            </button>
        </div>

        <!-- Résultats des tests -->
        <div class="test-results" id="test-results" style="display: none;">
            <div class="result-item" id="audio-result" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Audio fonctionne !</span>
            </div>
            <div class="result-item" id="micro-result" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Microphone fonctionne !</span>
            </div>
        </div>

        <!-- Bouton continuer -->
        <div class="continue-section">
            <button class="continue-btn" id="continue-btn" onclick="continueToQuestionnaire()" disabled>
                <i class="fas fa-arrow-right"></i>
                Continuer
            </button>
        </div>
    </div>
</div>

<script>
    let audioConfirmed = false;
    let microTested = false;
    let isRecording = false;
    let recognition = null;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('✅ Page Question 0 chargée');

        // Écouter la case à cocher
        const audioCheckbox = document.getElementById('audio-confirmed');
        if (audioCheckbox) {
            audioCheckbox.addEventListener('change', function () {
                audioConfirmed = this.checked;
                checkContinueButton();
            });
        }
    });

    function testAudio() {
        console.log('🔊 Test audio lancé');
        const btn = document.getElementById('test-audio-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lecture...';

        // Test audio avec fichier serveur
        const audio = new Audio('/api/test_audio');

        audio.addEventListener('canplaythrough', () => {
            console.log('Audio prêt');
        });

        audio.addEventListener('ended', () => {
            console.log('Audio terminé');
            showTestResult('audio-result');
            btn.innerHTML = '<i class="fas fa-check"></i> Audio testé';

            // Afficher la case à cocher
            document.getElementById('audio-confirmation').style.display = 'block';
        });

        audio.addEventListener('error', (e) => {
            console.log('Erreur audio, fallback vers synthèse vocale');

            // Fallback vers l'API de synthèse vocale du navigateur
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(
                    'Ceci est un test audio. Si vous entendez ce message, l\'audio fonctionne correctement.'
                );
                utterance.lang = 'fr-FR';
                utterance.rate = 0.8;
                utterance.pitch = 1;

                utterance.onend = () => {
                    showTestResult('audio-result');
                    btn.innerHTML = '<i class="fas fa-check"></i> Audio testé';
                    document.getElementById('audio-confirmation').style.display = 'block';
                };

                utterance.onerror = () => {
                    btn.innerHTML = '<i class="fas fa-times"></i> Erreur';
                    btn.disabled = false;
                    alert('Erreur : Impossible de jouer l\'audio. Vérifiez vos paramètres.');
                };

                speechSynthesis.speak(utterance);
            } else {
                btn.innerHTML = '<i class="fas fa-times"></i> Erreur';
                btn.disabled = false;
                alert('Erreur : Impossible de jouer l\'audio.');
            }
        });

        // Essayer de jouer l'audio
        audio.play().catch((error) => {
            console.log('Erreur lecture, fallback:', error);
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(
                    'Ceci est un test audio. Si vous entendez ce message, l\'audio fonctionne correctement.'
                );
                utterance.lang = 'fr-FR';
                utterance.rate = 0.8;

                utterance.onend = () => {
                    showTestResult('audio-result');
                    btn.innerHTML = '<i class="fas fa-check"></i> Audio testé';
                    document.getElementById('audio-confirmation').style.display = 'block';
                };

                speechSynthesis.speak(utterance);
            }
        });
    }

    function testMicrophone() {
        console.log('🎤 Test microphone lancé');

        // Afficher l'interface de test
        document.getElementById('microphone-test').style.display = 'block';
    }

    function startRecording() {
        if (isRecording) return;

        console.log('Démarrage enregistrement');

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Erreur : La reconnaissance vocale n\'est pas disponible sur ce navigateur.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.lang = 'fr-FR';
        recognition.continuous = true;
        recognition.interimResults = false;

        const btn = document.getElementById('recorder-btn');
        const feedback = document.getElementById('recording-feedback');

        recognition.onstart = () => {
            console.log('Reconnaissance démarrée');
            btn.innerHTML = '<i class="fas fa-stop"></i><span>🔴 Enregistrement...</span>';
            btn.classList.add('recording');
            isRecording = true;

            feedback.style.display = 'block';
            feedback.querySelector('.feedback-text').textContent = '🎤 Parlez maintenant... (attendez 2 secondes après)';
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            console.log('Résultat:', transcript);

            feedback.querySelector('.feedback-text').textContent = '✅ Message capté : "' + transcript + '"';
            feedback.querySelector('.feedback-text').style.color = '#4CAF50';

            showTestResult('micro-result');
            microTested = true;

            setTimeout(() => {
                stopRecording();
                checkContinueButton();
            }, 1500);
        };

        recognition.onerror = (event) => {
            console.log('Erreur reconnaissance:', event.error);

            if (event.error === 'not-allowed') {
                alert('Erreur : Vous devez autoriser l\'accès au microphone dans votre navigateur.');
            } else if (event.error === 'no-speech') {
                feedback.querySelector('.feedback-text').textContent = '⚠️ Aucune parole détectée. Réessayez en parlant plus fort.';
                feedback.querySelector('.feedback-text').style.color = '#FF9800';
            } else {
                alert('Erreur microphone : ' + event.error);
            }

            stopRecording();
        };

        recognition.onend = () => {
            console.log('Reconnaissance terminée');
        };

        try {
            recognition.start();

            // Timeout après 10 secondes
            setTimeout(() => {
                if (recognition && isRecording && !microTested) {
                    recognition.stop();
                    feedback.querySelector('.feedback-text').textContent = '⏱️ Temps écoulé. Cliquez à nouveau pour réessayer.';
                    feedback.querySelector('.feedback-text').style.color = '#FF9800';
                }
            }, 10000);
        } catch (error) {
            console.log('Erreur démarrage:', error);
            alert('Erreur : ' + error.message);
        }
    }

    function stopRecording() {
        if (recognition) {
            try {
                recognition.stop();
            } catch (e) {
                console.log('Erreur arrêt:', e);
            }
        }

        const btn = document.getElementById('recorder-btn');
        btn.innerHTML = '<i class="fas fa-microphone"></i><span>🎤 Tester</span>';
        btn.classList.remove('recording');
        isRecording = false;
    }

    function cancelMicrophoneTest() {
        stopRecording();
        document.getElementById('microphone-test').style.display = 'none';
    }

    function showTestResult(resultId) {
        document.getElementById(resultId).style.display = 'block';
        document.getElementById('test-results').style.display = 'block';
    }

    function checkContinueButton() {
        const continueBtn = document.getElementById('continue-btn');

        console.log('Vérification:', { audioConfirmed, microTested });

        if (audioConfirmed && microTested) {
            continueBtn.disabled = false;
            continueBtn.classList.add('enabled');
            console.log('✅ Bouton continuer activé');
        }
    }

    function continueToQuestionnaire() {
        console.log('🚀 Création de la session...');

        // Récupérer les données de session stockées
        const sessionData = JSON.parse(localStorage.getItem('pending_session_data'));

        if (!sessionData) {
            alert('Erreur : Données de session manquantes');
            window.location.href = '/';
            return;
        }

        const continueBtn = document.getElementById('continue-btn');
        continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création de la session...';
        continueBtn.disabled = true;

        // Créer la session via l'API
        const data = {
            ...sessionData,
            audio_enabled: true,
            mode: 'Continu (Web Speech)'
        };

        console.log('Données session:', data);

        fetch('/api/start_session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                console.log('Résultat:', result);

                if (result.success) {
                    // Stocker l'ID de session
                    localStorage.setItem('session_id', result.session_id);
                    localStorage.setItem('audio_tested', 'true');
                    localStorage.setItem('micro_tested', 'true');

                    // Nettoyer les données temporaires
                    localStorage.removeItem('pending_session_data');

                    console.log('✅ Session créée:', result.session_id);

                    // Rediriger vers le questionnaire
                    window.location.href = `/questionnaire?session_id=${result.session_id}`;
                } else {
                    throw new Error(result.error || 'Erreur création session');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur : ' + error.message);

                continueBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continuer';
                continueBtn.disabled = false;
            });
    }
</script>

<style>
    /* Styles spécifiques Question 0 */
    .audio-confirmation {
        margin: 2rem 0;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px solid #4CAF50;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .checkbox-validation {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .checkbox-label-large {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 500;
        padding: 1rem;
    }

    .checkbox-label-large input[type="checkbox"] {
        width: 28px;
        height: 28px;
        margin-right: 1rem;
        cursor: pointer;
        accent-color: #4CAF50;
    }

    .checkbox-text {
        color: #333;
    }

    .recording-feedback {
        margin-top: 1rem;
        padding: 1rem;
        background: #fff3cd;
        border-radius: 8px;
        text-align: center;
    }

    .feedback-text {
        font-size: 1.1rem;
        font-weight: 500;
        color: #856404;
    }

    .recorder-btn.recording {
        background: #f44336;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }
</style>
{% endblock %}