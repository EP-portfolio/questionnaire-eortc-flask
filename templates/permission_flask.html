{% extends "base_flask.html" %}

{% block title %}Tests Navigateur - Questionnaire EORTC QLQ-C30{% endblock %}

{% block content %}
<div class="permission-page">
    <!-- Titre principal -->
    <div class="welcome-box">
        <h1 class="welcome-title">
            <i class="fas fa-hospital"></i>
            Questionnaire EORTC QLQ-C30
        </h1>
        <p class="welcome-subtitle">Bienvenue ! Ce questionnaire Ã©value votre qualitÃ© de vie.</p>
    </div>

    <!-- SÃ©lection navigateur -->
    <div class="browser-selection" id="browser-selection">
        <div class="info-box">
            <h3 class="info-title">
                <i class="fas fa-globe"></i>
                Quel navigateur utilisez-vous ?
            </h3>
            <p class="info-text">
                Cette information nous permet d'optimiser votre expÃ©rience
            </p>
        </div>

        <div class="browser-buttons">
            <button class="browser-btn browser-chrome" onclick="selectBrowser(true)">
                <i class="fab fa-chrome"></i>
                <span>Chrome ou Edge</span>
                <small>Mode continu (1 clic)</small>
            </button>
            
            <button class="browser-btn browser-other" onclick="selectBrowser(false)">
                <i class="fas fa-browser"></i>
                <span>Firefox, Safari ou autre</span>
                <small>Mode standard</small>
            </button>
        </div>

        <div class="browser-info">
            <p class="info-tip">
                <i class="fas fa-lightbulb"></i>
                <strong>Chrome/Edge</strong> : Mode continu (1 seul clic) | 
                <strong>Autres</strong> : Mode standard (clic par question)
            </p>
        </div>
    </div>

    <!-- Tests recommandÃ©s -->
    <div class="tests-section" id="tests-section" style="display: none;">
        <div class="info-box">
            <h3 class="info-title">
                <i class="fas fa-clipboard-check"></i>
                Tests recommandÃ©s
            </h3>
            <p class="info-text">
                <strong>1. Testez l'audio</strong> pour vÃ©rifier que vous entendez les questions<br>
                <strong>2. Testez le microphone</strong> pour valider le fonctionnement<br>
                <strong>3. Autorisez l'accÃ¨s</strong> au micro dans le navigateur
            </p>
        </div>

        <div class="test-buttons">
            <div class="test-group">
                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-volume-up"></i>
                        Audio
                    </h4>
                    <p class="test-desc">Les questions seront lues Ã  voix haute.</p>
                    <button class="test-btn" onclick="testAudio()">
                        <i class="fas fa-play"></i>
                        Tester l'audio
                    </button>
                </div>

                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-microphone"></i>
                        Microphone
                    </h4>
                    <p class="test-desc">Validation du fonctionnement.</p>
                    <button class="test-btn" onclick="testMicrophone()">
                        <i class="fas fa-microphone"></i>
                        Tester le micro
                    </button>
                </div>
            </div>
        </div>

        <!-- Test microphone -->
        <div class="microphone-test" id="microphone-test" style="display: none;">
            <div class="test-info">
                <h4>Test : Cliquez, parlez, puis attendez 2 secondes</h4>
            </div>
            <div class="recorder-container">
                <button class="recorder-btn" id="recorder-btn" onclick="startRecording()">
                    <i class="fas fa-microphone"></i>
                    <span>ðŸŽ¤ Tester</span>
                </button>
            </div>
            <button class="cancel-btn" onclick="cancelMicrophoneTest()">
                <i class="fas fa-times"></i>
                Annuler
            </button>
        </div>

        <!-- RÃ©sultats des tests -->
        <div class="test-results" id="test-results" style="display: none;">
            <div class="result-item" id="audio-result" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Audio fonctionne !</span>
            </div>
            <div class="result-item" id="micro-result" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Microphone fonctionne !</span>
            </div>
        </div>

        <!-- Bouton continuer -->
        <div class="continue-section">
            <button class="continue-btn" id="continue-btn" onclick="continueToAccueil()" disabled>
                <i class="fas fa-arrow-right"></i>
                Continuer
            </button>
        </div>
    </div>
</div>

<script>
let selectedBrowser = null;
let audioTested = false;
let microTested = false;
let isRecording = false;
let mediaRecorder = null;

function selectBrowser(isChrome) {
    selectedBrowser = isChrome;
    
    // Masquer la sÃ©lection
    document.getElementById('browser-selection').style.display = 'none';
    
    // Afficher les tests
    document.getElementById('tests-section').style.display = 'block';
    
    // Afficher le message selon le navigateur
    const infoBox = document.querySelector('.info-box');
    if (isChrome) {
        infoBox.innerHTML = `
            <h3 class="info-title">
                <i class="fas fa-check-circle"></i>
                Mode continu activÃ©
            </h3>
            <p class="info-text">
                <strong>â†’ 1 SEUL clic au dÃ©marrage</strong><br>
                <strong>â†’ Parlez naturellement pour chaque question</strong><br>
                <strong>â†’ Passage automatique Ã  la question suivante</strong><br>
                <strong>â†’ Boutons disponibles si besoin</strong>
            </p>
        `;
    } else {
        infoBox.innerHTML = `
            <h3 class="info-title">
                <i class="fas fa-info-circle"></i>
                Mode standard
            </h3>
            <p class="info-text">
                Cliquez sur le micro pour chaque question<br>
                <strong>ðŸ’¡ Conseil :</strong> Utilisez Chrome ou Edge pour le mode continu
            </p>
        `;
    }
}

function testAudio() {
    // Test audio avec fichier serveur
    const audio = new Audio('/api/test_audio');
    
    audio.addEventListener('canplaythrough', () => {
        console.log('Audio prÃªt Ã  Ãªtre jouÃ©');
    });
    
    audio.addEventListener('ended', () => {
        showTestResult('audio-result');
        audioTested = true;
        checkContinueButton();
    });
    
    audio.addEventListener('error', (e) => {
        console.log('Erreur audio:', e);
        // Fallback vers l'API de synthÃ¨se vocale du navigateur
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('Test audio. Si vous entendez ce message, l\'audio fonctionne correctement.');
            utterance.lang = 'fr-FR';
            utterance.rate = 0.8;
            utterance.pitch = 1;
            
            utterance.onend = () => {
                showTestResult('audio-result');
                audioTested = true;
                checkContinueButton();
            };
            
            utterance.onerror = () => {
                alert('Erreur : Impossible de jouer l\'audio. VÃ©rifiez vos paramÃ¨tres.');
            };
            
            speechSynthesis.speak(utterance);
        } else {
            alert('Erreur : Impossible de jouer l\'audio. VÃ©rifiez vos paramÃ¨tres.');
        }
    });
    
    // Essayer de jouer l'audio
    audio.play().catch((error) => {
        console.log('Erreur de lecture audio:', error);
        // Fallback vers l'API de synthÃ¨se vocale
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('Test audio. Si vous entendez ce message, l\'audio fonctionne correctement.');
            utterance.lang = 'fr-FR';
            utterance.rate = 0.8;
            utterance.pitch = 1;
            
            utterance.onend = () => {
                showTestResult('audio-result');
                audioTested = true;
                checkContinueButton();
            };
            
            utterance.onerror = () => {
                alert('Erreur : Impossible de jouer l\'audio. VÃ©rifiez vos paramÃ¨tres.');
            };
            
            speechSynthesis.speak(utterance);
        } else {
            alert('Erreur : Impossible de jouer l\'audio. VÃ©rifiez vos paramÃ¨tres.');
        }
    });
}

function testMicrophone() {
    // Simuler le comportement du bouton "DÃ©marrer l'Ã©coute" du questionnaire
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showTestResult('micro-result', false);
        microTested = true;
        checkContinueButton();
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    
    recognition.lang = 'fr-FR';
    recognition.continuous = true;  // Mode continu comme le bouton "DÃ©marrer l'Ã©coute"
    recognition.interimResults = false;
    
    recognition.onstart = () => {
        console.log('Test micro: Reconnaissance vocale continue dÃ©marrÃ©e (simulation bouton DÃ©marrer l\'Ã©coute)');
        document.getElementById('microphone-test').style.display = 'block';
        document.getElementById('recorder-btn').innerHTML = '<i class="fas fa-microphone"></i><span>ðŸ”´ Ã‰coute continue active...</span>';
        document.getElementById('recorder-btn').classList.add('recording');
    };
    
    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        console.log('Test micro: RÃ©sultat reconnaissance continue:', transcript);
        showTestResult('micro-result');
        microTested = true;
        checkContinueButton();
        recognition.stop(); // ArrÃªter aprÃ¨s le premier rÃ©sultat
        document.getElementById('microphone-test').style.display = 'none';
    };
    
    recognition.onerror = (event) => {
        console.log('Test micro: Erreur reconnaissance:', event.error);
        showTestResult('micro-result', false);
        microTested = true;
        checkContinueButton();
        document.getElementById('microphone-test').style.display = 'none';
    };
    
    recognition.onend = () => {
        console.log('Test micro: Reconnaissance vocale continue terminÃ©e');
        document.getElementById('recorder-btn').innerHTML = '<i class="fas fa-microphone"></i><span>ðŸŽ¤ Tester</span>';
        document.getElementById('recorder-btn').classList.remove('recording');
    };
    
    try {
        recognition.start();
        // ArrÃªter automatiquement aprÃ¨s 5 secondes si pas de rÃ©sultat
        setTimeout(() => {
            if (recognition && recognition.state !== 'ended') {
                recognition.stop();
                if (!microTested) {
                    showTestResult('micro-result', false);
                    microTested = true;
                    checkContinueButton();
                    document.getElementById('microphone-test').style.display = 'none';
                }
            }
        }, 5000);
    } catch (error) {
        console.log('Test micro: Erreur dÃ©marrage reconnaissance:', error);
        showTestResult('micro-result', false);
        microTested = true;
        checkContinueButton();
        document.getElementById('microphone-test').style.display = 'none';
    }
}

function startRecording() {
    if (isRecording) return;
    
    const btn = document.getElementById('recorder-btn');
    btn.innerHTML = '<i class="fas fa-stop"></i><span>ðŸ”´ Enregistrement...</span>';
    btn.classList.add('recording');
    
    isRecording = true;
    
    // Simuler l'enregistrement
    setTimeout(() => {
        stopRecording();
    }, 3000);
}

function stopRecording() {
    if (!isRecording) return;
    
    const btn = document.getElementById('recorder-btn');
    btn.innerHTML = '<i class="fas fa-microphone"></i><span>ðŸŽ¤ Tester</span>';
    btn.classList.remove('recording');
    
    isRecording = false;
    
    // Simuler le succÃ¨s
    showTestResult('micro-result');
    microTested = true;
    checkContinueButton();
    
    // Masquer le test
    document.getElementById('microphone-test').style.display = 'none';
}

function cancelMicrophoneTest() {
    document.getElementById('microphone-test').style.display = 'none';
}

function showTestResult(resultId) {
    document.getElementById(resultId).style.display = 'block';
    document.getElementById('test-results').style.display = 'block';
}

function checkContinueButton() {
    const continueBtn = document.getElementById('continue-btn');
    if (audioTested && microTested) {
        continueBtn.disabled = false;
        continueBtn.classList.add('enabled');
    }
}

function continueToAccueil() {
    // Stocker les prÃ©fÃ©rences
    localStorage.setItem('browser_type', selectedBrowser ? 'chrome' : 'other');
    localStorage.setItem('audio_tested', 'true');
    localStorage.setItem('micro_tested', 'true');
    
    // Rediriger vers l'accueil
    window.location.href = '/accueil';
}
</script>
{% endblock %}
