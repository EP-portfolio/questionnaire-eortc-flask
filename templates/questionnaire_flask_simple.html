{% extends "base_flask.html" %}

{% block title %}Questionnaire - Question {{ current_question }}/30{% endblock %}

{% block content %}
<div class="questionnaire-page">
    <!-- Header avec progression -->
    <div class="question-header">
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="current-question">0</span>/30
                (<span id="progress-percent">0</span>%)
            </div>
        </div>

        <div class="navigation-buttons">
            <button class="nav-btn" id="prev-btn" onclick="previousQuestion()" disabled>
                <i class="fas fa-arrow-left"></i>
                Pr√©c√©dente
            </button>
            <button class="nav-btn" id="next-btn" onclick="nextQuestion()" disabled>
                Suivante
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Question 0 : Tests audio et micro -->
    <div class="question0-container" id="question0-container" style="display: none;">
        <div class="question-box">
            <div class="question-number">Question 0 - Tests pr√©alables</div>

            <!-- Encart texte pour Q0 -->
            <div class="question-speech"
                style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f7ff; border-left: 4px solid #2196F3; border-radius: 8px;">
                <div id="question0-speech-text"
                    style="white-space: pre-wrap; color: #333; line-height: 1.8; font-size: 1.1rem;">
                    Question z√©ro. Tests audio et microphone.
                    Si vous entendez ce message, l'audio fonctionne correctement.
                    Cochez la case, puis testez le microphone en parlant clairement.
                </div>
            </div>
        </div>

        <!-- Tests -->
        <div class="test-buttons" style="margin-top: 2rem;">
            <div class="test-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-volume-up"></i>
                        Audio
                    </h4>
                    <div style="padding: 1rem; text-align: center; color: #666; font-style: italic;">
                        L'audio se lancera automatiquement
                    </div>
                </div>

                <div class="test-box">
                    <h4 class="test-title">
                        <i class="fas fa-microphone"></i>
                        Microphone
                    </h4>
                    <button class="test-btn" id="test-micro-btn" onclick="testMicrophone()">
                        <i class="fas fa-microphone"></i>
                        Tester le micro
                    </button>
                </div>
            </div>
        </div>

        <!-- Case √† cocher -->
        <div class="audio-confirmation" id="audio-confirmation"
            style="margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #4CAF50;">
            <label class="checkbox-label-large"
                style="display: flex; align-items: center; cursor: pointer; font-size: 1.2rem;">
                <input type="checkbox" id="audio-confirmed" style="width: 24px; height: 24px; margin-right: 1rem;">
                <span>Cochez si vous avez entendu le test audio</span>
            </label>
        </div>

        <!-- Interface test micro -->
        <div class="microphone-test" id="microphone-test"
            style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="test-info">
                <h4>Test : Cliquez, parlez, puis attendez 2 secondes</h4>
            </div>
            <div class="recorder-container" style="text-align: center; margin: 1rem 0;">
                <button class="recorder-btn" id="recorder-btn" onclick="startRecording()"
                    style="font-size: 1.2rem; padding: 1rem 2rem;">
                    <i class="fas fa-microphone"></i>
                    <span>üé§ Tester</span>
                </button>
            </div>
            <div class="recording-feedback" id="recording-feedback"
                style="display: none; padding: 1rem; background: #fff3cd; border-radius: 8px; margin-top: 1rem;">
                <p class="feedback-text" style="margin: 0; font-size: 1.1rem; font-weight: 500;"></p>
            </div>
        </div>

        <!-- R√©sultats -->
        <div class="test-results" id="test-results" style="display: none; margin-top: 1.5rem;">
            <div class="result-item" id="micro-result"
                style="display: none; padding: 1rem; background: #d4edda; color: #155724; border-radius: 8px;">
                <i class="fas fa-check-circle"></i>
                <span>Microphone fonctionne !</span>
            </div>
        </div>

        <!-- Bouton pour passer √† Q1 -->
        <div class="continue-section" style="margin-top: 2rem; text-align: center;">
            <button class="continue-btn" id="q0-continue-btn" onclick="startRealQuestionnaire()" disabled
                style="font-size: 1.2rem; padding: 1rem 2rem; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-arrow-right"></i>
                Continuer vers Question 1
            </button>
        </div>
    </div>

    <!-- Questions 1-30 -->
    <div class="questions-container" id="questions-container" style="display: none;">
        <!-- Encart texte de la question (TOUJOURS VISIBLE) -->
        <div class="question-box" id="question-box">
            <div class="question-number" id="question-number">Question 1</div>
            <div class="question-speech"
                style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f7ff; border-left: 4px solid #2196F3; border-radius: 8px;">
                <div id="question-speech-text"
                    style="white-space: pre-wrap; color: #333; line-height: 1.8; font-size: 1.1rem;">
                    Chargement de la question...
                </div>
            </div>
        </div>

        <!-- Contr√¥les audio -->
        <div class="audio-controls"
            style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <button class="audio-btn" id="play-audio-btn" onclick="playQuestionAudio()"
                style="font-size: 1.3rem; padding: 1.2rem 2.5rem; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s;">
                <i class="fas fa-volume-up"></i>
                üîä √âcouter la question
            </button>
            <button class="audio-btn" id="stop-audio-btn" onclick="stopAudio()"
                style="display: none; font-size: 1.3rem; padding: 1.2rem 2.5rem; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <i class="fas fa-stop"></i>
                ‚èπÔ∏è Arr√™ter l'audio
            </button>

            <div id="audio-status" style="margin-top: 1rem; color: white; font-size: 1rem; font-weight: 500;">
                <span id="audio-status-text">üéµ Cliquez pour √©couter la question</span>
            </div>
        </div>

        <!-- R√©ponses manuelles -->
        <div class="responses-section" id="responses-section" style="margin-top: 2rem;">
            <h3 class="section-title">
                <i class="fas fa-mouse-pointer"></i>
                R√©ponse manuelle
            </h3>
            <div class="response-buttons" id="response-buttons">
                <!-- Les boutons seront g√©n√©r√©s dynamiquement -->
            </div>
        </div>

        <!-- Message sp√©cial pour Q29-30 -->
        <div class="special-message" id="special-message" style="display: none;">
            <div class="message-box">
                <i class="fas fa-info-circle"></i>
                <strong>Note :</strong> Pour les questions 29 et 30, utilisez l'√©chelle de 1 √† 7.
            </div>
        </div>
    </div>

    <!-- Statut √©coute continue (discret) -->
    <div class="listening-status" id="listening-status"
        style="position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: rgba(76, 175, 80, 0.9); color: white; border-radius: 8px; display: none; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
        <i class="fas fa-microphone"></i>
        <span id="listening-text">üé§ √âcoute active</span>
    </div>
</div>

<script src="{{ url_for('static', filename='js/speech_recognition_flask.js') }}"></script>
<script>
    let audioConfirmed = false;
    let microTested = false;
    let isRecording = false;
    let recognition = null;
    let currentQuestionNum = 0;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('‚úÖ Page questionnaire charg√©e');

        // Forcer l'activation de l'audio
        localStorage.setItem('audio_enabled', 'true');
        localStorage.setItem('browser_type', 'chrome');

        // Commencer par la Question 0
        showQuestion0();

        // Initialiser la reconnaissance vocale (mais ne pas d√©marrer encore)
        if (window.initSpeechRecognition) {
            initSpeechRecognition();
        }

        // √âcouter la case √† cocher
        const audioCheckbox = document.getElementById('audio-confirmed');
        if (audioCheckbox) {
            audioCheckbox.addEventListener('change', function () {
                audioConfirmed = this.checked;
                checkQ0ContinueButton();
            });
        }
    });

    function showQuestion0() {
        console.log('üìã Affichage Question 0');
        document.getElementById('question0-container').style.display = 'block';
        document.getElementById('questions-container').style.display = 'none';
        currentQuestionNum = 0;
        updateProgress();

        // ‚úÖ LANCER AUTOMATIQUEMENT L'AUDIO DE Q0
        setTimeout(() => {
            playQuestion0Audio();
        }, 500);
    }

    async function playQuestion0Audio() {
        console.log('üîä Lecture automatique audio Q0 (pr√©-g√©n√©r√©)');

        try {
            // Charger l'audio pr√©-g√©n√©r√© pour Q0
            const response = await fetch('/api/get_audio/0');

            if (response.ok) {
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                // Acc√©l√©ration de 15% comme pour les autres questions
                audio.playbackRate = 1.15;

                audio.onplay = () => {
                    console.log('üîä Audio Q0 d√©marr√© (fichier pr√©-g√©n√©r√©)');
                };

                audio.onended = () => {
                    console.log('‚úÖ Audio Q0 termin√©');
                    // La case √† cocher est d√©j√† visible
                };

                audio.onerror = (e) => {
                    console.error('Erreur lecture audio Q0:', e);
                    // Fallback : utiliser la synth√®se vocale du navigateur
                    playQuestion0AudioFallback();
                };

                await audio.play();
            } else {
                console.warn('Audio pr√©-g√©n√©r√© non disponible pour Q0, utilisation du fallback');
                playQuestion0AudioFallback();
            }
        } catch (error) {
            console.error('Erreur chargement audio Q0:', error);
            // Fallback : utiliser la synth√®se vocale du navigateur
            playQuestion0AudioFallback();
        }
    }

    // Fonction de secours avec synth√®se vocale du navigateur
    function playQuestion0AudioFallback() {
        console.log('üîä Lecture audio Q0 (synth√®se vocale fallback)');

        if ('speechSynthesis' in window) {
            const text = document.getElementById('question0-speech-text').textContent;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.85;
            utterance.pitch = 1;

            utterance.onstart = () => {
                console.log('üîä Audio Q0 (fallback) d√©marr√©');
            };

            utterance.onend = () => {
                console.log('‚úÖ Audio Q0 (fallback) termin√©');
            };

            utterance.onerror = (e) => {
                console.error('Erreur synth√®se vocale Q0:', e);
            };

            speechSynthesis.speak(utterance);
        }
    }

    function testAudio() {
        // FONCTION SUPPRIM√âE - L'audio se lance automatiquement
        console.log('testAudio() appel√© mais d√©sactiv√© - audio automatique');
    }

    function testMicrophone() {
        console.log('üé§ Test microphone');
        document.getElementById('microphone-test').style.display = 'block';
    }

    function startRecording() {
        if (isRecording) return;

        console.log('D√©marrage enregistrement');

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Erreur : La reconnaissance vocale n\'est pas disponible.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.lang = 'fr-FR';
        recognition.continuous = true;
        recognition.interimResults = false;

        const btn = document.getElementById('recorder-btn');
        const feedback = document.getElementById('recording-feedback');

        recognition.onstart = () => {
            console.log('Reconnaissance d√©marr√©e');
            btn.innerHTML = '<i class="fas fa-stop"></i><span>üî¥ Parlez...</span>';
            btn.style.background = '#f44336';
            isRecording = true;

            feedback.style.display = 'block';
            feedback.querySelector('.feedback-text').textContent = 'üé§ Parlez maintenant...';
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            console.log('R√©sultat:', transcript);

            feedback.querySelector('.feedback-text').textContent = '‚úÖ Message capt√© : "' + transcript + '"';
            feedback.querySelector('.feedback-text').style.color = '#4CAF50';

            showTestResult('micro-result');
            microTested = true;

            setTimeout(() => {
                if (recognition) recognition.stop();
                btn.innerHTML = '<i class="fas fa-check"></i><span>‚úÖ Test√©</span>';
                btn.style.background = '#4CAF50';
                btn.disabled = true;
                isRecording = false;
                checkQ0ContinueButton();
            }, 1500);
        };

        recognition.onerror = (event) => {
            console.log('Erreur:', event.error);
            if (event.error === 'not-allowed') {
                alert('Vous devez autoriser l\'acc√®s au microphone.');
            }
            if (recognition) recognition.stop();
            btn.innerHTML = '<i class="fas fa-microphone"></i><span>üé§ R√©essayer</span>';
            btn.style.background = '';
            isRecording = false;
        };

        try {
            recognition.start();
        } catch (error) {
            console.log('Erreur:', error);
            alert('Erreur : ' + error.message);
        }
    }

    function showTestResult(resultId) {
        document.getElementById(resultId).style.display = 'block';
        document.getElementById('test-results').style.display = 'block';
    }

    function checkQ0ContinueButton() {
        const btn = document.getElementById('q0-continue-btn');
        if (audioConfirmed && microTested) {
            btn.disabled = false;
            btn.style.cursor = 'pointer';
            btn.style.opacity = '1';
        }
    }

    function startRealQuestionnaire() {
        console.log('üöÄ D√©marrage questionnaire r√©el');

        // Masquer Q0, afficher Q1-30
        document.getElementById('question0-container').style.display = 'none';
        document.getElementById('questions-container').style.display = 'block';

        // Charger Q1
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(1);
        }

        // D√©marrer l'√©coute continue
        setTimeout(() => {
            if (window.speechManager) {
                window.speechManager.startContinuousSpeech();
                document.getElementById('listening-status').style.display = 'block';
            }
        }, 1000);
    }

    function updateProgress() {
        const total = 30;
        const percent = Math.round((currentQuestionNum / total) * 100);

        document.getElementById('current-question').textContent = currentQuestionNum;
        document.getElementById('progress-percent').textContent = percent;
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    function previousQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion - 1);
        }
    }

    function nextQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion + 1);
        }
    }

    function playQuestionAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.playQuestionAudio();
        }
    }

    function stopAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.stopAudio();
        }
    }
</script>

<style>
    .audio-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }

    .audio-btn:active {
        transform: translateY(0);
    }

    .test-btn,
    .recorder-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .test-btn:hover,
    .recorder-btn:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }

    .test-btn:disabled,
    .recorder-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .continue-btn:disabled {
        background: #ccc !important;
        cursor: not-allowed !important;
        opacity: 0.5;
    }
</style>
{% endblock %}