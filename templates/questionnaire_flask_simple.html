{% extends "base_flask.html" %}

{% block title %}Questionnaire - Question {{ current_question }}/30{% endblock %}

{% block content %}
<div class="questionnaire-page">
    <!-- Header avec progression -->
    <div class="question-header">
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="current-question">0</span>/30
                (<span id="progress-percent">0</span>%)
            </div>
        </div>

        <div class="navigation-buttons">
            <button class="nav-btn" id="prev-btn" onclick="previousQuestion()" disabled>
                <i class="fas fa-arrow-left"></i>
                PrÃ©cÃ©dente
            </button>
            <button class="nav-btn" id="next-btn" onclick="nextQuestion()" disabled>
                Suivante
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Question 0 : Tests audio et micro -->
    <div class="question0-container" id="question0-container" style="display: none;">
        <div class="question-box">
            <div class="question-number">Question 0 - Tests prÃ©alables</div>

            <!-- Encart texte pour Q0 -->
            <div class="question-speech"
                style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f7ff; border-left: 4px solid #2196F3; border-radius: 8px;">
                <div id="question0-speech-text"
                    style="white-space: pre-wrap; color: #333; line-height: 1.8; font-size: 1.1rem;">
                    Question zÃ©ro. Tests audio et microphone.
                    Si vous entendez ce message, l'audio fonctionne correctement.
                    Cochez la case, puis testez le microphone en parlant clairement.
                </div>
            </div>
        </div>

        <!-- Case Ã  cocher (JUSTE APRÃˆS le texte de Q0) -->
        <div class="audio-confirmation" id="audio-confirmation"
            style="margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #4CAF50;">
            <label class="checkbox-label-large"
                style="display: flex; align-items: center; cursor: pointer; font-size: 1.2rem;">
                <input type="checkbox" id="audio-confirmed" style="width: 24px; height: 24px; margin-right: 1rem;">
                <span>âœ… Cochez si vous avez entendu le test audio</span>
            </label>
        </div>

        <!-- Test Microphone -->
        <div class="test-buttons" style="margin-top: 2rem;">
            <div class="test-box"
                style="padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h4 class="test-title" style="margin-bottom: 1rem;">
                    <i class="fas fa-microphone"></i>
                    Microphone
                </h4>
                <button class="test-btn" id="test-micro-btn" onclick="testMicrophone()">
                    <i class="fas fa-microphone"></i>
                    Tester le micro
                </button>
            </div>
        </div>

        <!-- Interface test micro -->
        <div class="microphone-test" id="microphone-test"
            style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="test-info">
                <h4>Test : Cliquez, parlez, puis attendez 2 secondes</h4>
            </div>
            <div class="recorder-container" style="text-align: center; margin: 1rem 0;">
                <button class="recorder-btn" id="recorder-btn" onclick="startRecording()"
                    style="font-size: 1.2rem; padding: 1rem 2rem;">
                    <i class="fas fa-microphone"></i>
                    <span>ðŸŽ¤ Tester</span>
                </button>
            </div>
            <div class="recording-feedback" id="recording-feedback"
                style="display: none; padding: 1rem; background: #fff3cd; border-radius: 8px; margin-top: 1rem;">
                <p class="feedback-text" style="margin: 0; font-size: 1.1rem; font-weight: 500;"></p>
            </div>
        </div>

        <!-- RÃ©sultats -->
        <div class="test-results" id="test-results" style="display: none; margin-top: 1.5rem;">
            <div class="result-item" id="micro-result"
                style="display: none; padding: 1rem; background: #d4edda; color: #155724; border-radius: 8px;">
                <i class="fas fa-check-circle"></i>
                <span>Microphone fonctionne !</span>
            </div>
        </div>

        <!-- Bouton pour passer Ã  Q1 -->
        <div class="continue-section" style="margin-top: 2rem; text-align: center;">
            <button class="continue-btn" id="q0-continue-btn" onclick="startRealQuestionnaire()" disabled
                style="font-size: 1.2rem; padding: 1rem 2rem; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-arrow-right"></i>
                Continuer vers Question 1
            </button>
        </div>
    </div>

    <!-- Questions 1-30 -->
    <div class="questions-container" id="questions-container" style="display: none;">
        <!-- Encart texte de la question (TOUJOURS VISIBLE) -->
        <div class="question-box" id="question-box">
            <div class="question-number" id="question-number">Question 1</div>
            <div class="question-speech"
                style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f7ff; border-left: 4px solid #2196F3; border-radius: 8px;">
                <div id="question-speech-text"
                    style="white-space: pre-wrap; color: #333; line-height: 1.8; font-size: 1.1rem;">
                    Chargement de la question...
                </div>
            </div>
        </div>

        <!-- ContrÃ´les audio -->
        <div class="audio-controls"
            style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <button class="audio-btn" id="play-audio-btn" onclick="playQuestionAudio()"
                style="font-size: 1.3rem; padding: 1.2rem 2.5rem; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s;">
                <i class="fas fa-volume-up"></i>
                Ã‰couter la question
            </button>
            <button class="audio-btn" id="stop-audio-btn" onclick="stopAudio()"
                style="display: none; font-size: 1.3rem; padding: 1.2rem 2.5rem; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <i class="fas fa-stop"></i>
                ArrÃªter l'audio
            </button>

            <div id="audio-status"
                style="margin-top: 1rem; color: white; font-size: 1rem; font-weight: 500; display: none;">
                <span id="audio-status-text"></span>
            </div>
        </div>

        <!-- RÃ©ponses manuelles -->
        <div class="responses-section" id="responses-section" style="margin-top: 2rem;">
            <h3 class="section-title">
                <i class="fas fa-mouse-pointer"></i>
                RÃ©ponse manuelle
            </h3>
            <div class="response-buttons" id="response-buttons">
                <!-- Les boutons seront gÃ©nÃ©rÃ©s dynamiquement -->
            </div>
        </div>

        <!-- Message spÃ©cial pour Q29-30 -->
        <div class="special-message" id="special-message" style="display: none;">
            <div class="message-box">
                <i class="fas fa-info-circle"></i>
                <strong>Note :</strong> Pour les questions 29 et 30, utilisez l'Ã©chelle de 1 Ã  7.
            </div>
        </div>
    </div>

    <!-- Statut Ã©coute continue (discret) -->
    <div class="listening-status" id="listening-status"
        style="position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: rgba(76, 175, 80, 0.9); color: white; border-radius: 8px; display: none; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
        <i class="fas fa-microphone"></i>
        <span id="listening-text">ðŸŽ¤ Ã‰coute active</span>
    </div>
</div>

<script src="{{ url_for('static', filename='js/speech_recognition_flask.js') }}"></script>
<script>
    let audioConfirmed = false;
    let microTested = false;
    let isRecording = false;
    let recognition = null;
    let currentQuestionNum = 0;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('âœ… Page questionnaire chargÃ©e');

        // Forcer l'activation de l'audio
        localStorage.setItem('audio_enabled', 'true');
        // âœ… NE PAS forcer 'chrome' - laisser la dÃ©tection automatique

        // Commencer par la Question 0
        showQuestion0();

        // Initialiser la reconnaissance vocale (mais ne pas dÃ©marrer encore)
        // âœ… DÃ‰LAI pour s'assurer que speech_recognition_flask.js est chargÃ©
        setTimeout(() => {
            if (window.initSpeechRecognition) {
                console.log('ðŸ”§ Initialisation reconnaissance vocale...');
                initSpeechRecognition();
            } else {
                console.warn('âš ï¸ initSpeechRecognition non disponible');
            }
        }, 500);

        // Ã‰couter la case Ã  cocher
        const audioCheckbox = document.getElementById('audio-confirmed');
        if (audioCheckbox) {
            audioCheckbox.addEventListener('change', function () {
                audioConfirmed = this.checked;
                checkQ0ContinueButton();
            });
        }
    });

    function showQuestion0() {
        console.log('ðŸ“‹ Affichage Question 0');
        document.getElementById('question0-container').style.display = 'block';
        document.getElementById('questions-container').style.display = 'none';
        currentQuestionNum = 0;
        updateProgress();

        // âœ… LANCER AUTOMATIQUEMENT L'AUDIO DE Q0
        setTimeout(() => {
            playQuestion0Audio();
        }, 500);
    }

    async function playQuestion0Audio() {
        // âœ… VÃ‰RIFIER le consentement audio
        const audioConsent = localStorage.getItem('audio_consent') === 'true';
        if (!audioConsent) {
            console.log('âš ï¸ Consentement audio non accordÃ© - affichage du bouton de test');
            // Afficher un bouton pour tester l'audio
            showAudioTestButton();
            return;
        }

        console.log('ðŸ”Š Lecture automatique audio Q0 (prÃ©-gÃ©nÃ©rÃ©) - Consentement accordÃ©');

        // âœ… DÃ‰TECTER Firefox et afficher un bouton de dÃ©marrage
        const userAgent = navigator.userAgent.toLowerCase();
        const isFirefox = userAgent.includes('firefox');

        if (isFirefox) {
            console.log('ðŸ¦Š Firefox dÃ©tectÃ© - Affichage du bouton de dÃ©marrage audio');
            showFirefoxAudioButton();
            return;
        }

        try {
            // Charger l'audio prÃ©-gÃ©nÃ©rÃ© pour Q0
            console.log('ðŸ“¡ RequÃªte /api/get_audio/0...');
            const response = await fetch('/api/get_audio/0');
            console.log('ðŸ“¡ RÃ©ponse:', response.status, response.statusText);

            if (response.ok) {
                console.log('âœ… Audio prÃ©-gÃ©nÃ©rÃ© trouvÃ©, crÃ©ation du blob...');
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                // AccÃ©lÃ©ration de 15% comme pour les autres questions
                audio.playbackRate = 1.15;

                audio.onplay = () => {
                    console.log('ðŸ”Š Audio Q0 dÃ©marrÃ© (fichier prÃ©-gÃ©nÃ©rÃ©)');
                };

                audio.onended = () => {
                    console.log('âœ… Audio Q0 terminÃ©');
                    // La case Ã  cocher est dÃ©jÃ  visible
                };

                audio.onerror = (e) => {
                    console.error('Erreur lecture audio Q0:', e);
                    // Fallback : utiliser la synthÃ¨se vocale du navigateur
                    playQuestion0AudioFallback();
                };

                await audio.play();
            } else {
                console.warn('Audio prÃ©-gÃ©nÃ©rÃ© non disponible pour Q0, utilisation du fallback');
                playQuestion0AudioFallback();
            }
        } catch (error) {
            console.error('Erreur chargement audio Q0:', error);
            // Fallback : utiliser la synthÃ¨se vocale du navigateur
            playQuestion0AudioFallback();
        }
    }

    // Fonction de secours avec synthÃ¨se vocale du navigateur
    function playQuestion0AudioFallback() {
        console.log('ðŸ”Š Lecture audio Q0 (synthÃ¨se vocale fallback)');

        if ('speechSynthesis' in window) {
            const text = document.getElementById('question0-speech-text').textContent;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.85;
            utterance.pitch = 1;

            utterance.onstart = () => {
                console.log('ðŸ”Š Audio Q0 (fallback) dÃ©marrÃ©');
            };

            utterance.onend = () => {
                console.log('âœ… Audio Q0 (fallback) terminÃ©');
            };

            utterance.onerror = (e) => {
                console.error('Erreur synthÃ¨se vocale Q0:', e);
            };

            speechSynthesis.speak(utterance);
        }
    }

    function testAudio() {
        // FONCTION SUPPRIMÃ‰E - L'audio se lance automatiquement
        console.log('testAudio() appelÃ© mais dÃ©sactivÃ© - audio automatique');
    }

    function testMicrophone() {
        console.log('ðŸŽ¤ Test microphone');
        document.getElementById('microphone-test').style.display = 'block';
    }

    // Fonction pour afficher le bouton de test audio si pas de consentement
    function showAudioTestButton() {
        const audioConfirmation = document.getElementById('audio-confirmation');
        if (audioConfirmation) {
            // Ajouter un bouton de test audio
            const testButton = document.createElement('button');
            testButton.type = 'button';
            testButton.className = 'btn btn-primary btn-lg';
            testButton.style.cssText = 'width: 100%; padding: 1rem; font-size: 1.2rem; margin-bottom: 1rem;';
            testButton.innerHTML = 'ðŸ”Š Tester l\'audio maintenant';
            testButton.onclick = () => {
                // Marquer le consentement et jouer l'audio
                localStorage.setItem('audio_consent', 'true');
                localStorage.setItem('audio_enabled', 'true');
                playQuestion0Audio();
                testButton.remove();
            };

            audioConfirmation.insertBefore(testButton, audioConfirmation.firstChild);
        }
    }

    // Fonction pour afficher le bouton de dÃ©marrage audio pour Firefox
    function showFirefoxAudioButton() {
        const audioConfirmation = document.getElementById('audio-confirmation');
        if (audioConfirmation) {
            // Ajouter un bouton de dÃ©marrage audio pour Firefox
            const firefoxButton = document.createElement('button');
            firefoxButton.type = 'button';
            firefoxButton.className = 'btn btn-success btn-lg';
            firefoxButton.style.cssText = 'width: 100%; padding: 1rem; font-size: 1.2rem; margin-bottom: 1rem; background: #28a745; border-color: #28a745;';
            firefoxButton.innerHTML = 'ðŸ”Š DÃ©marrer l\'audio (Firefox)';
            firefoxButton.onclick = async () => {
                console.log('ðŸ¦Š Firefox - DÃ©marrage audio avec interaction utilisateur');
                await playQuestion0AudioDirect();
                firefoxButton.remove();
            };

            audioConfirmation.insertBefore(firefoxButton, audioConfirmation.firstChild);
        }
    }

    // Fonction pour jouer l'audio Q0 directement (sans vÃ©rifications)
    async function playQuestion0AudioDirect() {
        console.log('ðŸ”Š Lecture directe audio Q0 (prÃ©-gÃ©nÃ©rÃ©)');

        try {
            // Charger l'audio prÃ©-gÃ©nÃ©rÃ© pour Q0
            console.log('ðŸ“¡ RequÃªte /api/get_audio/0...');
            const response = await fetch('/api/get_audio/0');
            console.log('ðŸ“¡ RÃ©ponse:', response.status, response.statusText);

            if (response.ok) {
                console.log('âœ… Audio prÃ©-gÃ©nÃ©rÃ© trouvÃ©, crÃ©ation du blob...');
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                // AccÃ©lÃ©ration de 15% comme pour les autres questions
                audio.playbackRate = 1.15;

                audio.onplay = () => {
                    console.log('ðŸ”Š Audio Q0 dÃ©marrÃ© (fichier prÃ©-gÃ©nÃ©rÃ©)');
                };

                audio.onended = () => {
                    console.log('âœ… Audio Q0 terminÃ©');
                    URL.revokeObjectURL(audioUrl);
                };

                audio.onerror = (e) => {
                    console.error('Erreur lecture audio Q0:', e);
                    URL.revokeObjectURL(audioUrl);
                    // Fallback : utiliser la synthÃ¨se vocale du navigateur
                    playQuestion0AudioFallback();
                };

                await audio.play();
            } else {
                console.warn('Audio prÃ©-gÃ©nÃ©rÃ© non disponible pour Q0, utilisation du fallback');
                playQuestion0AudioFallback();
            }
        } catch (error) {
            console.error('Erreur chargement audio Q0:', error);
            // Fallback : utiliser la synthÃ¨se vocale du navigateur
            playQuestion0AudioFallback();
        }
    }

    function startRecording() {
        if (isRecording) return;

        console.log('DÃ©marrage enregistrement');

        // âœ… UTILISER LE SYSTÃˆME UNIFIÃ‰ (speech_recognition_flask.js)
        if (window.fallbackManager) {
            console.log('ðŸŽ¤ Firefox : Utilisation du FallbackRecognitionManager');

            // Simuler l'interface de test pour Firefox
            const btn = document.getElementById('recorder-btn');
            const feedback = document.getElementById('recording-feedback');

            btn.innerHTML = '<i class="fas fa-stop"></i><span>ðŸ”´ Parlez...</span>';
            btn.style.background = '#f44336';
            isRecording = true;

            feedback.style.display = 'block';
            feedback.querySelector('.feedback-text').textContent = 'ðŸŽ¤ Parlez maintenant...';

            // DÃ©marrer l'Ã©coute continue
            window.fallbackManager.startContinuousSpeech();

            // Ã‰couter les rÃ©sultats via le systÃ¨me unifiÃ©
            const originalProcessVoiceResponse = window.fallbackManager.processVoiceResponse;
            window.fallbackManager.processVoiceResponse = function (transcript) {
                console.log('ðŸŽ¤ Firefox : RÃ©sultat reÃ§u:', transcript);

                feedback.querySelector('.feedback-text').textContent = 'âœ… Message captÃ© : "' + transcript + '"';
                feedback.querySelector('.feedback-text').style.color = '#4CAF50';

                showTestResult('micro-result');
                microTested = true;

                setTimeout(() => {
                    window.fallbackManager.stopContinuousSpeech();
                    btn.innerHTML = '<i class="fas fa-check"></i><span>âœ… TestÃ©</span>';
                    btn.style.background = '#4CAF50';
                    btn.disabled = true;
                    isRecording = false;
                    checkQ0ContinueButton();

                    // âœ… REDÃ‰MARRER Firefox aprÃ¨s le test micro
                    console.log('ðŸ¦Š Firefox : RedÃ©marrage aprÃ¨s test micro');
                    window.fallbackManager.startContinuousSpeech();
                }, 1500);

                // Restaurer la fonction originale
                window.fallbackManager.processVoiceResponse = originalProcessVoiceResponse;
            };

            return;
        }

        // âœ… VÃ‰RIFICATION : Chrome/Edge uniquement
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            console.log('ðŸ¦Š Firefox dÃ©tectÃ© - Utilisation du fallbackManager');
            // Pour Firefox, utiliser le fallbackManager au lieu de Web Speech API
            if (window.fallbackManager) {
                console.log('âœ… fallbackManager disponible - DÃ©marrage Firefox');
                window.fallbackManager.startContinuousSpeech();
                return;
            } else {
                console.error('âŒ fallbackManager non disponible - Attendre l\'initialisation');
                // âœ… RETRY : Attendre que fallbackManager soit crÃ©Ã©
                setTimeout(() => {
                    if (window.fallbackManager) {
                        console.log('âœ… fallbackManager maintenant disponible - DÃ©marrage Firefox');
                        window.fallbackManager.startContinuousSpeech();
                    } else {
                        alert('Erreur : La reconnaissance vocale n\'est pas disponible sur Firefox.');
                    }
                }, 1000);
                return;
            }
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.lang = 'fr-FR';
        recognition.continuous = true;
        recognition.interimResults = false;

        const btn = document.getElementById('recorder-btn');
        const feedback = document.getElementById('recording-feedback');

        recognition.onstart = () => {
            console.log('Reconnaissance dÃ©marrÃ©e');
            btn.innerHTML = '<i class="fas fa-stop"></i><span>ðŸ”´ Parlez...</span>';
            btn.style.background = '#f44336';
            isRecording = true;

            feedback.style.display = 'block';
            feedback.querySelector('.feedback-text').textContent = 'ðŸŽ¤ Parlez maintenant...';
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            console.log('RÃ©sultat:', transcript);

            feedback.querySelector('.feedback-text').textContent = 'âœ… Message captÃ© : "' + transcript + '"';
            feedback.querySelector('.feedback-text').style.color = '#4CAF50';

            showTestResult('micro-result');
            microTested = true;

            setTimeout(() => {
                if (recognition) recognition.stop();
                btn.innerHTML = '<i class="fas fa-check"></i><span>âœ… TestÃ©</span>';
                btn.style.background = '#4CAF50';
                btn.disabled = true;
                isRecording = false;
                checkQ0ContinueButton();
            }, 1500);
        };

        recognition.onerror = (event) => {
            console.log('Erreur:', event.error);
            if (event.error === 'not-allowed') {
                alert('Vous devez autoriser l\'accÃ¨s au microphone.');
            }
            if (recognition) recognition.stop();
            btn.innerHTML = '<i class="fas fa-microphone"></i><span>ðŸŽ¤ RÃ©essayer</span>';
            btn.style.background = '';
            isRecording = false;
        };

        try {
            recognition.start();
        } catch (error) {
            console.log('Erreur:', error);
            alert('Erreur : ' + error.message);
        }
    }

    function showTestResult(resultId) {
        document.getElementById(resultId).style.display = 'block';
        document.getElementById('test-results').style.display = 'block';
    }

    function checkQ0ContinueButton() {
        const btn = document.getElementById('q0-continue-btn');
        if (audioConfirmed && microTested) {
            btn.disabled = false;
            btn.style.cursor = 'pointer';
            btn.style.opacity = '1';
        }
    }

    function startRealQuestionnaire() {
        console.log('ðŸš€ DÃ©marrage questionnaire rÃ©el');

        // Masquer Q0, afficher Q1-30
        document.getElementById('question0-container').style.display = 'none';
        document.getElementById('questions-container').style.display = 'block';

        // Charger Q1
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(1);
        }

        // DÃ©marrer l'Ã©coute continue
        setTimeout(() => {
            if (window.speechManager) {
                // Chrome/Edge - Web Speech API
                window.speechManager.startContinuousSpeech();
                document.getElementById('listening-status').style.display = 'block';
            } else if (window.fallbackManager) {
                // Firefox - Fallback avec serveur
                console.log('ðŸ¦Š Firefox : RedÃ©marrage Ã©coute continue pour questionnaire');
                window.fallbackManager.startContinuousSpeech();
                document.getElementById('listening-status').style.display = 'block';
            }
        }, 1000);
    }

    function updateProgress() {
        const total = 30;
        const percent = Math.round((currentQuestionNum / total) * 100);

        document.getElementById('current-question').textContent = currentQuestionNum;
        document.getElementById('progress-percent').textContent = percent;
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    function previousQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion - 1);
        }
    }

    function nextQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion + 1);
        }
    }

    function playQuestionAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.playQuestionAudio();
        }
    }

    function stopAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.stopAudio();
        }
    }
</script>

<style>
    .audio-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }

    .audio-btn:active {
        transform: translateY(0);
    }

    .test-btn,
    .recorder-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .test-btn:hover,
    .recorder-btn:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }

    .test-btn:disabled,
    .recorder-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .continue-btn:disabled {
        background: #ccc !important;
        cursor: not-allowed !important;
        opacity: 0.5;
    }
</style>
{% endblock %}