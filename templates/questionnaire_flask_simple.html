{% extends "base_flask.html" %}

{% block title %}Questionnaire - Question {{ current_question }}/30{% endblock %}

{% block content %}
<div class="questionnaire-page">
    <!-- Header avec progression -->
    <div class="question-header">
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="current-question">1</span>/30
                (<span id="progress-percent">3</span>%)
            </div>
        </div>

        <div class="navigation-buttons">
            <button class="nav-btn" id="prev-btn" onclick="previousQuestion()" disabled>
                <i class="fas fa-arrow-left"></i>
                Pr√©c√©dente
            </button>
            <button class="nav-btn" id="next-btn" onclick="nextQuestion()" disabled>
                Suivante
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Question (simplifi√©) -->
    <div class="question-container">
        <div class="question-box" id="question-box">
            <div class="question-number" id="question-number">Question 1</div>
            <div class="question-text" id="question-text"
                style="font-size: 1.3rem; font-weight: 500; color: #333; line-height: 1.4;">
                Chargement de la question...
            </div>
        </div>
    </div>

    <!-- Contr√¥les audio (mis en √©vidence) -->
    <div class="audio-controls"
        style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <button class="audio-btn" id="play-audio-btn" onclick="playQuestionAudio()"
            style="font-size: 1.3rem; padding: 1.2rem 2.5rem; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s;">
            <i class="fas fa-volume-up"></i>
            üîä √âcouter la question
        </button>
        <button class="audio-btn" id="stop-audio-btn" onclick="stopAudio()"
            style="display: none; font-size: 1.3rem; padding: 1.2rem 2.5rem; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            <i class="fas fa-stop"></i>
            ‚èπÔ∏è Arr√™ter l'audio
        </button>

        <div id="audio-status" style="margin-top: 1rem; color: white; font-size: 1rem; font-weight: 500;">
            <span id="audio-status-text">üéµ Cliquez pour √©couter la question</span>
        </div>
    </div>

    <!-- R√©ponses manuelles -->
    <div class="responses-section" id="responses-section" style="margin-top: 2rem;">
        <h3 class="section-title">
            <i class="fas fa-mouse-pointer"></i>
            R√©ponse manuelle
        </h3>
        <div class="response-buttons" id="response-buttons">
            <!-- Les boutons seront g√©n√©r√©s dynamiquement -->
        </div>
    </div>

    <!-- Message sp√©cial pour Q29-30 -->
    <div class="special-message" id="special-message" style="display: none;">
        <div class="message-box">
            <i class="fas fa-info-circle"></i>
            <strong>Note :</strong> Pour les questions 29 et 30, utilisez l'√©chelle de 1 √† 7.
            R√©pondez par "un", "deux", "trois", "quatre", "cinq", "six", ou "sept".
        </div>
    </div>

    <!-- Statut √©coute continue (discret) -->
    <div class="listening-status" id="listening-status"
        style="position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: rgba(0,0,0,0.8); color: white; border-radius: 8px; display: none; z-index: 1000;">
        <i class="fas fa-microphone"></i>
        <span id="listening-text">√âcoute active</span>
    </div>
</div>

<script src="{{ url_for('static', filename='js/speech_recognition_flask.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('‚úÖ Page questionnaire charg√©e');

        // Forcer l'activation de l'audio
        localStorage.setItem('audio_enabled', 'true');
        console.log('‚úÖ Audio forc√© √† : true');

        // V√©rifier le mode navigateur (toujours Chrome maintenant)
        localStorage.setItem('browser_type', 'chrome');

        // Initialiser la reconnaissance vocale
        initSpeechRecognition();

        // D√©marrer automatiquement l'√©coute continue
        setTimeout(() => {
            if (window.speechManager) {
                window.speechManager.startContinuousSpeech();
                // Afficher le statut
                document.getElementById('listening-status').style.display = 'block';
            }
        }, 1000);
    });

    function previousQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion - 1);
        }
    }

    function nextQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion + 1);
        }
    }

    function playQuestionAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.playQuestionAudio();
        }
    }

    function stopAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.stopAudio();
        }
    }
</script>

<style>
    .audio-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }

    .audio-btn:active {
        transform: translateY(0);
    }

    .question-text {
        /* Forcer le texte sur une seule ligne si trop long */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Version responsive pour petits √©crans */
    @media (max-width: 768px) {
        .question-text {
            white-space: normal;
            overflow: visible;
        }
    }
</style>
{% endblock %}