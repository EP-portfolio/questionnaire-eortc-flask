{% extends "base_flask.html" %}

{% block title %}Questionnaire - Question {{ current_question }}/30{% endblock %}

{% block content %}
<div class="questionnaire-page">
    <!-- Header avec progression -->
    <div class="question-header">
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="current-question">1</span>/30
                (<span id="progress-percent">3</span>%)
            </div>
        </div>

        <div class="navigation-buttons">
            <button class="nav-btn" id="prev-btn" onclick="previousQuestion()" disabled>
                <i class="fas fa-arrow-left"></i>
                Pr√©c√©dente
            </button>
            <button class="nav-btn" id="next-btn" onclick="nextQuestion()" disabled>
                Suivante
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Question -->
    <div class="question-container">
        <div class="question-box" id="question-box">
            <div class="question-number" id="question-number">Question 1</div>
            <div class="question-text" id="question-text"
                style="white-space: pre-wrap; line-height: 1.6; font-size: 1.1rem;">
                Chargement de la question...
            </div>
            <div class="question-speech" id="question-speech"
                style="margin-top: 1.5rem; padding: 1rem; background: #f0f7ff; border-left: 4px solid #2196F3; border-radius: 4px; display: none;">
                <strong style="color: #1976D2;">üì¢ Texte complet (lu par l'audio) :</strong>
                <div id="question-speech-text" style="margin-top: 0.5rem; white-space: pre-wrap; color: #424242;"></div>
            </div>
        </div>
    </div>

    <!-- Interface vocale -->
    <div class="voice-section" id="voice-section">
        <h3 class="section-title">
            <i class="fas fa-microphone"></i>
            R√©ponse vocale
        </h3>

        <!-- Mode Web Speech API (Chrome/Edge) -->
        <div class="web-speech-interface" id="web-speech-interface" style="display: none;">
            <div class="speech-status" id="speech-status">
                <div class="status-indicator" id="status-indicator">
                    <i class="fas fa-microphone-slash"></i>
                    Micro inactif
                </div>
                <div class="status-message" id="status-message">
                    Cliquez sur le bouton pour commencer l'√©coute continue
                </div>
            </div>

            <div class="speech-controls">
                <button class="voice-btn" id="start-listening-btn" onclick="startListening()">
                    <i class="fas fa-microphone"></i>
                    D√©marrer l'√©coute
                </button>
                <button class="voice-btn stop-btn" id="stop-listening-btn" onclick="stopListening()"
                    style="display: none;">
                    <i class="fas fa-stop"></i>
                    Arr√™ter l'√©coute
                </button>
            </div>

            <div class="speech-feedback" id="speech-feedback" style="display: none;">
                <div class="feedback-text" id="feedback-text"></div>
                <div class="feedback-actions" id="feedback-actions"></div>
            </div>
        </div>

        <!-- Mode fallback (autres navigateurs) -->
        <div class="fallback-interface" id="fallback-interface" style="display: none;">
            <div class="fallback-message">
                <i class="fas fa-info-circle"></i>
                Votre navigateur ne supporte pas la reconnaissance vocale continue.
                Utilisez les boutons de r√©ponse ci-dessous.
            </div>
        </div>
    </div>

    <!-- R√©ponses manuelles -->
    <div class="responses-section" id="responses-section">
        <h3 class="section-title">
            <i class="fas fa-mouse-pointer"></i>
            R√©ponse manuelle
        </h3>
        <div class="response-buttons" id="response-buttons">
            <!-- Les boutons seront g√©n√©r√©s dynamiquement -->
        </div>
    </div>

    <!-- Contr√¥les audio TOUJOURS visibles et mis en √©vidence -->
    <div class="audio-controls"
        style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <button class="audio-btn" id="play-audio-btn" onclick="playQuestionAudio()"
            style="font-size: 1.3rem; padding: 1.2rem 2.5rem; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s;">
            <i class="fas fa-volume-up"></i>
            üîä √âcouter la question
        </button>
        <button class="audio-btn" id="stop-audio-btn" onclick="stopAudio()"
            style="display: none; font-size: 1.3rem; padding: 1.2rem 2.5rem; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            <i class="fas fa-stop"></i>
            ‚èπÔ∏è Arr√™ter l'audio
        </button>

        <div id="audio-status" style="margin-top: 1rem; color: white; font-size: 1rem; font-weight: 500;">
            <span id="audio-status-text">üéµ Cliquez pour √©couter la question</span>
        </div>
    </div>

    <!-- Message sp√©cial pour Q29-30 -->
    <div class="special-message" id="special-message" style="display: none;">
        <div class="message-box">
            <i class="fas fa-info-circle"></i>
            <strong>Note :</strong> Pour les questions 29 et 30, utilisez l'√©chelle de 1 √† 7.
            R√©pondez par "un", "deux", "trois", "quatre", "cinq", "six", ou "sept".
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/speech_recognition_flask.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('‚úÖ Page questionnaire charg√©e');

        // FORCER l'activation de l'audio
        localStorage.setItem('audio_enabled', 'true');
        console.log('‚úÖ Audio forc√© √†: true');

        // V√©rifier le mode navigateur
        const browserType = localStorage.getItem('browser_type');
        const isWebSpeechMode = browserType === 'chrome';

        // Afficher la bonne interface
        if (isWebSpeechMode) {
            document.getElementById('web-speech-interface').style.display = 'block';
        } else {
            document.getElementById('fallback-interface').style.display = 'block';
        }

        // Initialiser la reconnaissance vocale si disponible
        if (isWebSpeechMode) {
            initSpeechRecognition();
        }
    });

    function previousQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion - 1);
        }
    }

    function nextQuestion() {
        if (window.questionnaireManager) {
            window.questionnaireManager.loadQuestion(window.questionnaireManager.currentQuestion + 1);
        }
    }

    function startListening() {
        if (window.speechManager) {
            window.speechManager.startContinuousSpeech();
        }
    }

    function stopListening() {
        if (window.speechManager) {
            window.speechManager.stopContinuousSpeech();
        }
    }

    function playQuestionAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.playQuestionAudio();
        }
    }

    function stopAudio() {
        if (window.questionnaireManager) {
            window.questionnaireManager.stopAudio();
        }
    }
</script>

<style>
    .audio-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }

    .audio-btn:active {
        transform: translateY(0);
    }
</style>
{% endblock %}