{% extends "base_flask.html" %}

{% block title %}R√©sultats - Questionnaire EORTC QLQ-C30{% endblock %}

{% block content %}
<div class="resultat-page">
    <!-- Titre de succ√®s -->
    <div class="success-header">
        <h1 class="success-title">
            <i class="fas fa-trophy"></i>
            Questionnaire termin√© !
        </h1>
        <p class="success-subtitle">F√©licitations, vous avez compl√©t√© l'√©valuation de votre qualit√© de vie.</p>
    </div>

    <!-- Statistiques -->
    <div class="stats-section">
        <h2 class="section-title">
            <i class="fas fa-chart-bar"></i>
            Statistiques
        </h2>

        <div class="stats-grid" id="stats-grid">
            <!-- Sera rempli par JavaScript -->
        </div>
    </div>

    <!-- Informations personnelles -->
    <div class="info-section">
        <h2 class="section-title">
            <i class="fas fa-user"></i>
            Informations personnelles
        </h2>

        <div class="info-grid" id="info-grid">
            <!-- Sera rempli par JavaScript -->
        </div>
    </div>

    <!-- D√©tail des r√©ponses -->
    <div class="responses-section">
        <h2 class="section-title">
            <i class="fas fa-list"></i>
            D√©tail des r√©ponses
        </h2>

        <div class="responses-table-container">
            <table class="responses-table" id="responses-table">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Texte</th>
                        <th>R√©ponse</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="responses-tbody">
                    <!-- Sera rempli par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Questions manqu√©es -->
    <div class="missed-section" id="missed-section" style="display: none;">
        <div class="warning-box">
            <h3>
                <i class="fas fa-exclamation-triangle"></i>
                Questions non r√©pondues
            </h3>
            <p id="missed-text"></p>
            <button class="action-btn" onclick="resumeQuestionnaire()">
                <i class="fas fa-play"></i>
                Reprendre les questions manqu√©es
            </button>
        </div>
    </div>

    <!-- Export des donn√©es -->
    <div class="export-section">
        <h2 class="section-title">
            <i class="fas fa-download"></i>
            Export des donn√©es
        </h2>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportData('json')">
                <i class="fas fa-file-code"></i>
                T√©l√©charger JSON
            </button>
            <button class="export-btn" onclick="exportData('csv')">
                <i class="fas fa-file-csv"></i>
                T√©l√©charger CSV
            </button>
            <button class="export-btn" onclick="exportData('excel')">
                <i class="fas fa-file-excel"></i>
                T√©l√©charger Excel
            </button>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-section">
        <div class="action-buttons">
            <button class="action-btn primary" onclick="startNewQuestionnaire()">
                <i class="fas fa-redo"></i>
                Recommencer un nouveau questionnaire
            </button>
            <button class="action-btn secondary" onclick="goHome()">
                <i class="fas fa-home"></i>
                Retour √† l'accueil
            </button>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <span>Les donn√©es sont stock√©es localement jusqu'au t√©l√©chargement.</span>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let sessionData = null;
    let responses = [];
    let statistics = {};

    // Initialisation
    document.addEventListener('DOMContentLoaded', function () {
        loadSessionData();

        // Lancer l'audio apr√®s 1 seconde
        setTimeout(() => {
            playResultsAudio();
        }, 1000);
    });

    async function playResultsAudio() {
        try {
            console.log('üîä Lecture audio r√©sultats (message pr√©-g√©n√©r√©)');

            // ‚úÖ D√âTECTER Firefox et afficher un bouton de d√©marrage audio
            const userAgent = navigator.userAgent.toLowerCase();
            const isFirefox = userAgent.includes('firefox');

            if (isFirefox) {
                console.log('ü¶ä Firefox d√©tect√© - Affichage du bouton de d√©marrage audio pour r√©sultats');
                showFirefoxResultsAudioButton();
                return;
            }

            // Utiliser le message de f√©licitations g√©n√©rique pr√©-g√©n√©r√©
            const response = await fetch(`/api/get_result_audio/complete`);

            if (response.ok) {
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.playbackRate = 1.15;

                await audio.play();
                console.log('‚úÖ Audio r√©sultats jou√© (f√©licitations)');
            } else {
                console.warn('Audio r√©sultats non disponible');
            }
        } catch (error) {
            console.error('Erreur lecture audio r√©sultats:', error);
        }
    }

    // ‚úÖ NOUVELLE FONCTION : Bouton Firefox pour audio r√©sultats
    function showFirefoxResultsAudioButton() {
        const successHeader = document.querySelector('.success-header');
        if (successHeader) {
            const firefoxButton = document.createElement('button');
            firefoxButton.type = 'button';
            firefoxButton.className = 'action-btn primary';
            firefoxButton.style.cssText = 'margin: 1rem auto; display: block; padding: 1rem 2rem; font-size: 1.2rem;';
            firefoxButton.innerHTML = 'üîä √âcouter le message de f√©licitations (Firefox)';
            firefoxButton.onclick = async () => {
                console.log('ü¶ä Firefox - D√©marrage audio r√©sultats avec interaction utilisateur');
                await playResultsAudioDirect();
                firefoxButton.remove();
            };

            successHeader.appendChild(firefoxButton);
        }
    }

    // ‚úÖ NOUVELLE FONCTION : Lecture directe audio r√©sultats (sans v√©rifications)
    async function playResultsAudioDirect() {
        console.log('üîä Lecture directe audio r√©sultats (pr√©-g√©n√©r√©)');

        try {
            const response = await fetch(`/api/get_result_audio/complete`);

            if (response.ok) {
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.playbackRate = 1.15;

                await audio.play();
                console.log('‚úÖ Audio r√©sultats jou√© (fichier pr√©-g√©n√©r√©)');
            } else {
                console.warn('Audio r√©sultats non disponible');
            }
        } catch (error) {
            console.error('Erreur lecture audio r√©sultats:', error);
        }
    }

    async function loadSessionData() {
        try {
            const response = await fetch(`/api/get_session_data/{{ session_id }}`);
            const result = await response.json();

            if (result.success) {
                sessionData = result.session;
                responses = result.responses;
                statistics = result.statistics;

                displayStatistics();
                displayPersonalInfo();
                displayResponses();
                checkMissedQuestions();
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Erreur chargement donn√©es:', error);
            alert('Erreur : ' + error.message);
        }
    }

    function displayStatistics() {
        const statsGrid = document.getElementById('stats-grid');

        const stats = [
            {
                icon: 'fas fa-question-circle',
                label: 'Questions r√©pondues',
                value: `${statistics.answered}/30`
            },
            {
                icon: 'fas fa-percentage',
                label: 'Taux de compl√©tion',
                value: `${statistics.completion_rate.toFixed(1)}%`
            },
            {
                icon: 'fas fa-chart-line',
                label: 'Score moyen',
                value: statistics.average_score ? statistics.average_score.toFixed(2) : 'N/A'
            },
            {
                icon: 'fas fa-clock',
                label: 'Dur√©e',
                value: calculateDuration()
            }
        ];

        statsGrid.innerHTML = stats.map(stat => `
        <div class="stat-card">
            <div class="stat-icon">
                <i class="${stat.icon}"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
            </div>
        </div>
    `).join('');
    }

    function displayPersonalInfo() {
        const infoGrid = document.getElementById('info-grid');

        const info = [
            {
                icon: 'fas fa-signature',
                label: 'Initiales',
                value: sessionData.initials
            },
            {
                icon: 'fas fa-calendar-alt',
                label: 'Date de naissance',
                value: sessionData.birth_date
            },
            {
                icon: 'fas fa-calendar-check',
                label: 'Date du questionnaire',
                value: sessionData.today_date
            },
            {
                icon: 'fas fa-microphone',
                label: 'Mode',
                value: sessionData.mode
            }
        ];

        infoGrid.innerHTML = info.map(item => `
        <div class="info-item">
            <div class="info-icon">
                <i class="${item.icon}"></i>
            </div>
            <div class="info-content">
                <div class="info-label">${item.label}</div>
                <div class="info-value">${item.value}</div>
            </div>
        </div>
    `).join('');
    }

    function displayResponses() {
        const tbody = document.getElementById('responses-tbody');

        // Cr√©er un tableau avec toutes les questions (EXCLURE Q0)
        const allQuestions = [];
        for (let i = 1; i <= 30; i++) { // ‚úÖ Commence √† 1, pas 0
            const response = responses.find(r => r.question_num === i);
            allQuestions.push({
                question_num: i,
                response: response
            });
        }

        tbody.innerHTML = allQuestions.map(item => {
            const response = item.response;
            if (response) {
                return `
                <tr class="response-row answered">
                    <td>Q${item.question_num}</td>
                    <td class="question-text">${truncateText(response.question_text, 60)}</td>
                    <td class="response-text">${response.response_text}</td>
                    <td class="score">${response.score}</td>
                </tr>
            `;
            } else {
                return `
                <tr class="response-row missed">
                    <td>Q${item.question_num}</td>
                    <td class="question-text">Question ${item.question_num}</td>
                    <td class="response-text">Non r√©pondu</td>
                    <td class="score">-</td>
                </tr>
            `;
            }
        }).join('');
    }

    function checkMissedQuestions() {
        if (statistics.missed > 0) {
            const missedNums = [];
            for (let i = 1; i <= 30; i++) { // ‚úÖ Commence √† 1, pas 0
                if (!responses.find(r => r.question_num === i)) {
                    missedNums.push(i);
                }
            }

            document.getElementById('missed-text').textContent =
                `${statistics.missed} question(s) non r√©pondue(s) : ${missedNums.join(', ')}`;
            document.getElementById('missed-section').style.display = 'block';
        }
    }

    function calculateDuration() {
        if (sessionData.created_at && sessionData.completed_at) {
            const start = new Date(sessionData.created_at);
            const end = new Date(sessionData.completed_at);
            const duration = Math.floor((end - start) / 1000 / 60);
            return `${duration} min`;
        }
        return 'N/A';
    }

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    async function exportData(format) {
        try {
            const response = await fetch(`/api/export_session/{{ session_id }}`);
            const result = await response.json();

            if (result.success) {
                const data = result.data;

                if (format === 'json') {
                    downloadJSON(data);
                } else if (format === 'csv') {
                    downloadCSV(data);
                } else if (format === 'excel') {
                    downloadExcel(data);
                }
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Erreur export:', error);
            alert('Erreur : ' + error.message);
        }
    }

    function downloadJSON(data) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eortc_questionnaire_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function downloadCSV(data) {
        // Cr√©er les donn√©es CSV
        const csvData = [];

        // Informations personnelles
        Object.entries(data.session).forEach(([key, value]) => {
            if (key !== 'id' && key !== 'created_at' && key !== 'completed_at') {
                csvData.push(['Info personnelle', key, value, '']);
            }
        });

        // R√©ponses
        data.responses.forEach(response => {
            csvData.push([
                'R√©ponse',
                `Q${response.question_num}: ${response.question_text}`,
                response.response_text,
                response.score
            ]);
        });

        // Cr√©er le CSV
        const csvContent = [
            ['Type', 'Question', 'R√©ponse', 'Score'],
            ...csvData
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eortc_questionnaire_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function downloadExcel(data) {
        // Pour Excel, on utilise une approche simplifi√©e
        // En production, on pourrait utiliser une librairie comme SheetJS
        alert('Export Excel non impl√©ment√© dans cette version. Utilisez CSV ou JSON.');
    }

    function resumeQuestionnaire() {
        // Trouver la premi√®re question non r√©pondue
        let firstMissed = null;
        for (let i = 1; i <= 30; i++) {
            if (!responses.find(r => r.question_num === i)) {
                firstMissed = i;
                break;
            }
        }

        if (firstMissed) {
            window.location.href = `/questionnaire?session_id={{ session_id }}&question=${firstMissed}`;
        }
    }

    function startNewQuestionnaire() {
        // Nettoyer le localStorage
        localStorage.removeItem('session_id');
        localStorage.removeItem('browser_type');
        localStorage.removeItem('audio_tested');
        localStorage.removeItem('micro_tested');

        // Rediriger vers l'accueil
        window.location.href = '/accueil';
    }

    function goHome() {
        window.location.href = '/';
    }
</script>
{% endblock %}