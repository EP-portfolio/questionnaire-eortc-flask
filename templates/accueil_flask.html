{% extends "base_flask.html" %}

{% block title %}Accueil - Questionnaire EORTC QLQ-C30{% endblock %}

{% block content %}
<div class="accueil-page">
    <!-- Message de bienvenue -->
    <div class="welcome-box">
        <h1 class="welcome-title">
            <i class="fas fa-hospital"></i>
            Questionnaire EORTC QLQ-C30
        </h1>
        <p class="welcome-subtitle">Bienvenue ! Ce questionnaire √©value votre qualit√© de vie.</p>
    </div>

    <!-- Formulaire informations personnelles -->
    <div class="form-section">
        <h2 class="form-title">
            <i class="fas fa-user"></i>
            Informations personnelles
        </h2>

        <form id="personal-form" class="personal-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="initials" class="form-label">
                        <i class="fas fa-signature"></i>
                        Initiales
                    </label>
                    <input type="text" id="initials" name="initials" class="form-input" maxlength="10"
                        placeholder="Ex: A B" required>
                    <small class="form-help">Vos initiales (ex: A B pour Andr√© Bernard)</small>
                </div>

                <div class="form-group">
                    <label for="birth_date" class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        Date de naissance
                    </label>
                    <input type="date" id="birth_date" name="birth_date" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="today_date" class="form-label">
                        <i class="fas fa-calendar-check"></i>
                        Date d'aujourd'hui
                    </label>
                    <input type="date" id="today_date" name="today_date" class="form-input" required>
                </div>
            </div>

            <div class="form-options">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="consent" name="consent" required>
                        <span class="checkmark"></span>
                        <i class="fas fa-shield-alt"></i>
                        J'accepte le traitement anonyme de mes donn√©es (RGPD)
                    </label>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="audio_consent" name="audio_consent" required>
                        <span class="checkmark"></span>
                        <i class="fas fa-volume-up"></i>
                        J'autorise la lecture automatique des questions audio
                    </label>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="submit-btn" id="submit-btn" disabled>
                    <i class="fas fa-arrow-right"></i>
                    CONTINUER
                </button>
            </div>
        </form>
    </div>

    <!-- Aide contextuelle -->
    <div class="help-section">
        <h3 class="help-title">
            <i class="fas fa-question-circle"></i>
            Aide
        </h3>
        <div class="help-buttons">
            <button class="help-btn" onclick="showHelp('initials')">
                <i class="fas fa-signature"></i>
                Initiales
            </button>
            <button class="help-btn" onclick="showHelp('birth')">
                <i class="fas fa-calendar-alt"></i>
                Naissance
            </button>
            <button class="help-btn" onclick="showHelp('today')">
                <i class="fas fa-calendar-check"></i>
                Aujourd'hui
            </button>
        </div>
    </div>
</div>

<script>
    console.log('üöÄ Page accueil charg√©e');

    // Initialisation
    document.addEventListener('DOMContentLoaded', function () {
        console.log('‚úÖ DOM charg√©');

        // D√©finir la date d'aujourd'hui par d√©faut
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('today_date').value = today;

        // D√©finir une date de naissance par d√©faut (1970)
        document.getElementById('birth_date').value = '1970-01-01';

        // Forcer le mode Chrome (toujours mode continu)
        localStorage.setItem('browser_type', 'chrome');
        console.log('‚úÖ Mode Chrome activ√©');

        // G√©rer le formulaire
        setupFormHandlers();
    });

    function setupFormHandlers() {
        const form = document.getElementById('personal-form');
        const submitBtn = document.getElementById('submit-btn');
        const consentCheckbox = document.getElementById('consent');

        console.log('‚úÖ Handlers configur√©s');

        // G√©rer la validation du formulaire
        function validateForm() {
            const initials = document.getElementById('initials').value.trim();
            const birthDate = document.getElementById('birth_date').value;
            const todayDate = document.getElementById('today_date').value;
            const consent = consentCheckbox.checked;
            const audioConsent = document.getElementById('audio_consent').checked;

            if (initials && birthDate && todayDate && consent && audioConsent) {
                submitBtn.disabled = false;
                submitBtn.classList.add('enabled');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('enabled');
            }
        }

        // √âcouter les changements
        form.addEventListener('input', validateForm);
        form.addEventListener('change', validateForm);

        // G√©rer la soumission
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            console.log('üìù Formulaire soumis');

            // R√©cup√©rer les donn√©es
            const formData = new FormData(form);
            const data = {
                initials: formData.get('initials'),
                birth_date: formData.get('birth_date'),
                today_date: formData.get('today_date'),
                audio_enabled: formData.get('audio_consent') === 'on',
                audio_consent: formData.get('audio_consent') === 'on',
                mode: 'Continu (Web Speech)'
            };

            console.log('üíæ Donn√©es:', data);

            // Afficher le loading
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation de la session...';
            submitBtn.disabled = true;

            // Cr√©er la session directement
            fetch('/api/start_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Stocker l'ID de session
                        localStorage.setItem('session_id', result.session_id);

                        // Stocker le consentement audio
                        localStorage.setItem('audio_consent', 'true');
                        localStorage.setItem('audio_enabled', 'true');

                        console.log('‚úÖ Session cr√©√©e:', result.session_id);
                        console.log('‚úÖ Consentement audio accord√©');

                        // Rediriger vers le questionnaire (qui commencera par Q0)
                        window.location.href = `/questionnaire?session_id=${result.session_id}`;
                    } else {
                        throw new Error(result.error || 'Erreur cr√©ation session');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur : ' + error.message);

                    // Restaurer le bouton
                    submitBtn.innerHTML = '<i class="fas fa-arrow-right"></i> CONTINUER';
                    submitBtn.disabled = false;
                });
        });
    }

    function showHelp(type) {
        let message = '';

        switch (type) {
            case 'initials':
                message = 'Saisissez vos initiales. Par exemple, A B pour Andr√© Bernard.';
                break;
            case 'birth':
                message = 'S√©lectionnez votre date de naissance dans le calendrier.';
                break;
            case 'today':
                const today = new Date();
                const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                    'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                message = `La date est le ${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}.`;
                break;
        }

        // Utiliser l'API de synth√®se vocale si disponible
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'fr-FR';
            speechSynthesis.speak(utterance);
        } else {
            alert(message);
        }
    }

    console.log('üí° Page accueil pr√™te');
</script>
{% endblock %}